<mat-card class="cardWithShadow m-4">
  <mat-card-content>
    <mat-card-title class="w-100 d-flex justify-content-between align-items-center mb-3" style="font-size: 1.5rem; font-weight: 600;">
      Avis sur {{ hotel?.nom_hotel || 'Hôtel' }} ({{ hotel?.marque || 'Marque' }})
      <button mat-icon-button color="primary" onclick="window.close()" matTooltip="Fermer la fenêtre">
        <mat-icon>close</mat-icon>
      </button>
    </mat-card-title>

    <div *ngIf="isLoading" class="loading" style="font-style: italic; color: #666;">
      Chargement des avis...
    </div>

    <div *ngIf="!isLoading && errorMessage" class="error" style="color: red; font-weight: 500;">
      {{ errorMessage }}
    </div>

    <div *ngIf="!isLoading && !errorMessage && reviews.length === 0" class="no-data" style="color: #999;">
      Aucun avis disponible pour cet hôtel.
    </div>

    <table mat-table [dataSource]="reviews" class="mat-elevation-z8 w-100" style="border-radius: 8px; overflow: hidden;" *ngIf="!isLoading && !errorMessage && reviews.length > 0">
      <!-- Titre Column -->
      <ng-container matColumnDef="titre">
        <th mat-header-cell *matHeaderCellDef style="background-color: #83b3ff; color: white; font-weight: 500;">Titre</th>
        <td mat-cell *matCellDef="let review" style="padding: 12px;">{{ review.title }}</td>
      </ng-container>

      <!-- Note Column -->
      <ng-container matColumnDef="note">
        <th mat-header-cell *matHeaderCellDef style="background-color: #83b3ff; color: white; font-weight: 500;">Note</th>
        <td mat-cell *matCellDef="let review" style="padding: 12px;">{{ review.rating }}/5</td>
      </ng-container>

      <!-- Commentaire Column -->
      <ng-container matColumnDef="commentaire">
        <th mat-header-cell *matHeaderCellDef style="background-color: #83b3ff; color: white; font-weight: 500;">Commentaire</th>
        <td mat-cell *matCellDef="let review" class="comment-cell" [class.expanded]="showFullText === review.id" style="padding: 12px;">
          <span>
            <ng-container *ngIf="review.text.length > 100 && showFullText !== review.id">
              {{ review.text | slice:0:100 }}...
              <a (click)="toggleFullText(review.id)" class="voir-plus" style="color: #1976d2; cursor: pointer;">Voir plus</a>
            </ng-container>
            <ng-container *ngIf="review.text.length <= 100 || showFullText === review.id">
              {{ review.text }}
              <a *ngIf="review.text.length > 100" (click)="toggleFullText(review.id)" class="voir-moins" style="color: #1976d2; cursor: pointer;">Voir moins</a>
            </ng-container>
          </span>
        </td>
      </ng-container>

      <!-- Date de Publication Column -->
      <ng-container matColumnDef="date_publication">
        <th mat-header-cell *matHeaderCellDef style="background-color: #83b3ff; color: white; font-weight: 500;">Date de Publication</th>
        <td mat-cell *matCellDef="let review" style="padding: 12px;">{{ review.published_date | date:'mediumDate' }}</td>
      </ng-container>

      <!-- Type de Voyage Column -->
      <ng-container matColumnDef="type_voyage">
        <th mat-header-cell *matHeaderCellDef style="background-color: #83b3ff; color: white; font-weight: 500;">Type de Voyage</th>
        <td mat-cell *matCellDef="let review" style="padding: 12px;">{{ review.trip_type || 'N/A' }}</td>
      </ng-container>

      <!-- Lien Column -->
      <ng-container matColumnDef="lien">
        <th mat-header-cell *matHeaderCellDef style="background-color: #83b3ff; color: white; font-weight: 500;">Lien</th>
        <td mat-cell *matCellDef="let review" style="padding: 12px;">
          <a [href]="review.url" target="_blank" mat-icon-button>
            <mat-icon>link</mat-icon>
          </a>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"
          style="transition: background-color 0.2s; cursor: pointer;"
          (mouseover)="row.hover = true"
          (mouseout)="row.hover = false"
          [style.background-color]="row.hover ? '#f1f5ff' : 'white'">
      </tr>
    </table>

    <mat-card-actions *ngIf="!isLoading && !errorMessage && reviews.length > 0" style="margin-top: 16px;">
      <button mat-raised-button color="primary" (click)="loadAnalysis()" [disabled]="isAnalysisLoading">
        {{ isAnalysisLoading ? 'Chargement...' : 'Générer une analyse' }}
      </button>
    </mat-card-actions>

    <div *ngIf="isAnalysisLoading" class="loading" style="font-style: italic; color: #666; margin-top: 16px;">
      Chargement de l'analyse...
    </div>

    <div *ngIf="analysis" class="analysis-section mt-4" style="margin-top: 24px; background-color: #f9fbff; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <h3 style="color: #1a237e; font-size: 1.8rem; font-weight: 600; margin-bottom: 16px;">Analyse des avis pour {{ analysis.nom_hotel }}</h3>
      <div class="analysis-content" style="font-size: 1rem; line-height: 1.6; color: #333;">
        <h4 style="color: #1976d2; font-size: 1.4rem; font-weight: 500; margin-top: 20px; margin-bottom: 10px;">Note Globale</h4>
        <p style="margin-bottom: 16px;" [innerHTML]="analysis.note_globale | markdown"></p>

        <h4 style="color: #1976d2; font-size: 1.4rem; font-weight: 500; margin-top: 20px; margin-bottom: 10px;">Analyse des Sentiments</h4>
        <p style="margin-bottom: 16px;" [innerHTML]="analysis.analyse_des_sentiments | markdown"></p>

        <h4 style="color: #1976d2; font-size: 1.4rem; font-weight: 500; margin-top: 20px; margin-bottom: 10px;">Insights</h4>
        <p style="margin-bottom: 16px;" [innerHTML]="analysis.insights | markdown"></p>

        <h4 style="color: #1976d2; font-size: 1.4rem; font-weight: 500; margin-top: 20px; margin-bottom: 10px;">Conclusion</h4>
        <p style="margin-bottom: 16px;" [innerHTML]="analysis.conclusion | markdown"></p>
      </div>
    </div>
  </mat-card-content>
</mat-card>